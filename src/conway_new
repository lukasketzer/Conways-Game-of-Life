#include <stdio.h>
#include <time.h>
#include <stdint.h>
#include <stdlib.h>
#include <stdbool.h>
#include "defs.h"

#include "conway_new.h"



u8 CGOL_getValue(CGOL *cgol, usize x, usize y) {
    // HACK: Veiileicht gibt es hier einen wraparound der dann falsch ist
    if (x > cgol->width  || y > cgol->height ) return 0;
    usize idx = (cgol->width * y + x); 
    usize part = idx >> 6; // div by 64
    u8 offset = idx % sizeof(u64);
     
    return cgol->universe[part] & (1LL << offset) ? 1 : 0;
}

void CGOL_setValue(CGOL *cgol, usize x, usize y, bool alive){
    if (x > cgol->width || y > cgol->height) return;
    usize idx = (cgol->width * y + x); 
    usize part = idx >> 6; // div by 64
    u8 offset = idx % sizeof(u64);
    
    if (alive) {
        cgol->universe[part] |= 1LL << offset ;
    } else {
        cgol->universe[part] &= ~(1LL << offset);
    }
}


u64* allocUniverse(usize width, usize height, usize *universeSize){
    if (__builtin_umull_overflow(width, height, universeSize)) {
        fprintf(stderr, "width and hight are too large");
        exit(EXIT_FAILURE);
    }

    u64 *universe = calloc((*universeSize / sizeof(u64)) + 1, sizeof(u64));

    if(!universe) {
        fprintf(stderr, "Error while allocating board");
        exit(EXIT_FAILURE);
    }
    return universe;
}

// DONE
void CGOL_fillUniverseRandom(CGOL *cgol, u32 chance) {
    for(usize y = 0; y < cgol->height; y++) {
        for(usize x = 0; x < cgol->width; x++) {
            if ((rand() % chance) == 0) {
                CGOL_setValue(cgol, x , y, true);
            }
        }
    }
}

// DONE
void CGOL_clear(CGOL *cgol) {
    free(cgol->universe);
    u64 *universe = allocUniverse(cgol->width, cgol->height, &cgol->universeSize);
    cgol->universe = universe;
    return;
}



void CGOL_print(CGOL *cgol) {
    for(usize y = 0; y < cgol->height; y++) {
        for(usize x = 0; x < cgol->width; x++) {
            CGOL_getValue(cgol, x, y) ?  printf("■") : printf("□");
        }
        printf("\n");
    }
}

u8 getSurroundingValues(CGOL *cgol, usize x, usize y) {
    u8 value = 0; 
    value += CGOL_getValue(cgol, x-1, y-1);
    value += CGOL_getValue(cgol, x,   y-1);
    value += CGOL_getValue(cgol, x+1, y-1);

    value += CGOL_getValue(cgol, x-1, y);
    value += CGOL_getValue(cgol, x+1, y);

    value += CGOL_getValue(cgol, x-1, y+1);
    value += CGOL_getValue(cgol, x,   y+1);
    value += CGOL_getValue(cgol, x+1, y+1);

    return value;
}

void updateBoard(CGOL *cgol) {
    // TODO: funkioniert nicht
    u8 neighbours;
    bool alive;

    CGOL *cgol_new = CGOL_createWorld(cgol->width, cgol->height);
    u64 *old_universe = cgol->universe;
    
    for(usize y = 0; y < cgol->height; y++) {
        for(usize x = 0; x < cgol->width; x++) {
            neighbours = getSurroundingValues(cgol, x, y);
            alive = CGOL_getValue(cgol, x, y);

            // Gamerules
            if (!alive && neighbours == 3){
                CGOL_setValue(cgol_new, x, y, true);                // lives
            } else if (alive && neighbours < 2) {
                continue;                                       // dies
            } else if (alive && (neighbours == 2 || neighbours == 3)) {
                CGOL_setValue(cgol, x, y, true);                // lives
            } else if (alive && neighbours > 3) {
                continue;                                       // dies
            } else {
                continue;                                       // dies
            }

        }
    }
    cgol->universe = cgol_new->universe;
    free(old_universe);
    free(cgol_new);
}



CGOL* CGOL_createWorld(usize width, usize height) {
    usize universeSize;
    CGOL *cgol = (CGOL*) malloc(sizeof(CGOL));

    if(!cgol) {
        fprintf(stderr, "Error while allocating board");
        exit(EXIT_FAILURE);
    }

    u64 *universe = allocUniverse(width, height, &universeSize);

    
    cgol->universe = universe;
    cgol->universeSize = universeSize;
    cgol->width = width;
    cgol->height = height;

    return cgol;
}

void CGOL_iterate(CGOL *cgol) {
    if (!cgol) {
        fprintf(stderr, "No object supplied. Maybe you didn't initalize the config");
        exit(EXIT_FAILURE);
    }
    updateBoard(cgol);
}




int main() {
    srand(time(NULL));
    CGOL *cgol = CGOL_createWorld(10, 5);
    CGOL_fillUniverseRandom(cgol, 5);
    CGOL_print(cgol);
    printf("=========================================\n");
    CGOL_iterate(cgol);
    CGOL_print(cgol);

}
